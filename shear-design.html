<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC Design | Shear & Stirrups (SI)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- MathJax for LaTeX -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .grid-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .unit {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        /* Results & Visualization */
        .results-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .canvas-container {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            height: 350px;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            overflow: hidden;
        }

        canvas { max-width: 100%; max-height: 100%; }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 10px;
        }
        .status-ok { background: #d1fae5; color: #065f46; }
        .status-fail { background: #fee2e2; color: #991b1b; }

        .math-row {
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .check-card {
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }
        .check-card.pass { border-left: 5px solid var(--success); }
        .check-card.fail { border-left: 5px solid var(--error); }
        .check-card.warn { border-left: 5px solid var(--warning); }
        
        .check-card h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .math-block {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
            border-left: 4px solid var(--accent);
            overflow-x: auto;
        }

        .warning-box {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .result-list {
            list-style: none;
            padding: 0;
        }
        .result-list li {
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <a href="index.html" class="back-btn">
            <i class="fa-solid fa-arrow-left"></i> Dashboard
        </a>

        <div class="input-panel">
            <h2 class="panel-title">Shear Properties</h2>
            
                <div class="section-header">Material Properties</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Concrete $f'_c$ (MPa)</label>
                        <input type="number" id="fc" value="28">
                    </div>
                    <div class="form-col">
                        <label>Steel $f_{yt}$ (MPa)</label>
                        <input type="number" id="fy" value="420" min="1">
                    </div>
                </div>

                <div class="section-header">Geometry</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Width $b_w$ (mm)</label>
                        <input type="number" id="bw" value="300">
                    </div>
                    <div class="form-col">
                        <label>Depth $h$ (mm)</label>
                        <input type="number" id="h" value="500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Cover (mm)</label>
                        <input type="number" id="cover" value="40">
                    </div>
                    <div class="form-col">
                        <label>Span $L_n$ (m)</label>
                        <input type="number" id="span" value="6.0" step="0.1">
                    </div>
                </div>

                <div class="section-header">Loading</div>
                <div class="form-group">
                    <label>Factored Load $w_u$ (kN/m)</label>
                    <input type="number" id="wu" value="65" step="0.5">
                </div>

                <div class="section-header">Reinforcement</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Bar Size</label>
                        <select id="barSize">
                            <option value="50">8 mm</option>
                            <option value="79" selected>10 mm</option>
                            <option value="113">12 mm</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Legs</label>
                        <select id="legs">
                            <option value="2">2 Legs</option>
                            <option value="4">4 Legs</option>
                        </select>
                    </div>
                </div>

                <button class="calc-btn" onclick="calculateShear()">
                    <i class="fa-solid fa-calculator"></i> Calculate Design
                </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Hero Section -->
        <div class="hero">
            <h1>Shear & Stirrups Design</h1>
            <p>Determine shear capacity ($\phi V_c$) and design vertical stirrup spacing ($s$) for rectangular beams based on ACI 318M-11.</p>
        </div>

        <div class="grid-container">
                
                <!-- Visualization -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Detailing Visualization</h3>
                    <div class="canvas-container">
                        <div style="text-align: center;">
                            <h4 style="font-size: 0.85rem; color: #64748b;">Beam Elevation</h4>
                            <canvas id="beamCanvas"></canvas>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="font-size: 0.85rem; color: #64748b;">Isometric Cage View</h4>
                            <canvas id="isoCanvas"></canvas>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: #64748b; margin-top: 10px; text-align: center;">
                        *Visual representation of half-span. Stirrup density indicates spacing.
                    </p>
                </div>

                <!-- Detailed Summary -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">Calculation Summary (ACI 318M-11)</h3>
                    <div id="summaryContent" class="summary-box">
                        <p style="color: var(--text-muted); font-style: italic;">Enter parameters and click Calculate to view results.</p>
                    </div>
                </div>

            </div>
    </main>

    <script>
        // SI Constants
        const PHI_SHEAR = 0.75;
        const LAMBDA = 1.0; // Normal weight concrete assumption
        
        function calculateShear() {
            // 1. Get Inputs
            const fc = parseFloat(document.getElementById('fc').value);
            const fyt = parseFloat(document.getElementById('fy').value);
            const bw = parseFloat(document.getElementById('bw').value);
            const h = parseFloat(document.getElementById('h').value);
            const cover = parseFloat(document.getElementById('cover').value);
            const Ln = parseFloat(document.getElementById('span').value); // Meters
            const wu = parseFloat(document.getElementById('wu').value); // kN/m
            const barArea = parseFloat(document.getElementById('barSize').value);
            const legs = parseFloat(document.getElementById('legs').value);

            // Validation to prevent numerical instability or infinite loops
            if (isNaN(fc) || fc < 12 || isNaN(fyt) || fyt < 200) {
                document.getElementById('summaryContent').innerHTML = "<p style='color: var(--error); font-weight: 600; padding: 1rem;'>Please enter valid material properties ($f'_c \ge 12$ MPa and $f_{yt} \ge 200$ MPa) to proceed with the calculation.</p>";
                return;
            }

            // 2. Preliminary Calcs
            // Estimate effective depth d (assume one layer of tension steel approx 25mm dia)
            // d = h - cover - stirrup_dia (approx 10) - longitudinal_bar_radius (approx 12)
            const d = h - cover - 10 - 12.5; 
            const Av = barArea * legs; // Total area of stirrup legs
            const Ln_mm = Ln * 1000;

            // 3. Shear Analysis
            // Reaction at support (Simply supported)
            const Vu_support = (wu * Ln) / 2; // kN
            
            // Critical Shear at distance d from support
            // Slope of shear diagram = -wu
            // Vu_d = Vu_support - wu * (d/1000)
            const Vu_critical = Vu_support - (wu * (d / 1000));
            
            // 4. Concrete Capacity (ACI 318M-11 Eq 11-3)
            // Vc = 0.17 * lambda * sqrt(fc) * bw * d (result in N, convert to kN)
            const Vc_N = 0.17 * LAMBDA * Math.sqrt(fc) * bw * d;
            const Vc = Vc_N / 1000; // kN
            const phiVc = PHI_SHEAR * Vc;
            const halfPhiVc = 0.5 * phiVc;

            // 5. Sanity Checks
            // Check if section is large enough (Vs limit)
            // Vs_max limit = 0.66 * sqrt(fc) * bw * d
            const Vs_max_allowed_N = 0.66 * Math.sqrt(fc) * bw * d;
            const Vs_max_allowed = Vs_max_allowed_N / 1000;
            
            // Required Vs at critical section
            // Vu = phi(Vc + Vs) -> Vs_req = (Vu - phiVc) / phi
            let Vs_req = 0;
            if (Vu_critical > phiVc) {
                Vs_req = (Vu_critical - phiVc) / PHI_SHEAR;
            }

            let statusHtml = "";
            let isSectionTooSmall = false;

            if (Vs_req > Vs_max_allowed) {
                statusHtml += `<div class='summary-item'><span class='status-badge status-fail'>Section Too Small</span> <br> $V_s$ required (${Vs_req.toFixed(2)} kN) > Max Allowed (${Vs_max_allowed.toFixed(2)} kN). Increase beam size.</div>`;
                isSectionTooSmall = true;
            }

            // Fitment Check (Is width enough for legs?)
            // Approx: 2 * cover + 2 * stirrup_dia + (legs-1)*spacing_between_legs
            // Rough check: can we fit legs?
            const stirrupDia = barArea === 50 ? 8.0 : (barArea === 79 ? 10.0 : 12.0);
            const minWidth = (2 * cover) + (2 * stirrupDia) + ((legs - 1) * 25); // 25mm min gap
            if (bw < minWidth) {
                statusHtml += `<div class='summary-item'><span class='status-badge status-warning'>Congestion Warning</span> <br> Beam width may be too narrow for ${legs} legs. Min width approx ${minWidth.toFixed(0)}mm.</div>`;
            }

            // 6. Stirrup Spacing Calculations
            // Max Spacing per Code (ACI 11.4.5)
            // If Vs <= 0.33 sqrt(fc) bw d -> s_max = min(d/2, 600mm)
            // If Vs > 0.33 sqrt(fc) bw d -> s_max = min(d/4, 300mm)
            const Vs_threshold_N = 0.33 * Math.sqrt(fc) * bw * d;
            const Vs_threshold = Vs_threshold_N / 1000;
            
            let s_max_code;
            if (Vs_req > Vs_threshold) {
                s_max_code = Math.min(d / 4, 300);
            } else {
                s_max_code = Math.min(d / 2, 600);
            }

            // Minimum Area Requirement (ACI 11.4.6.3)
            // Av_min = 0.062 sqrt(fc) (bw s)/fyt >= 0.35 bw s / fyt
            // Solve for s_max based on Av provided:
            // s_Avmin1 = (Av * fyt) / (0.062 * sqrt(fc) * bw)
            // s_Avmin2 = (Av * fyt) / (0.35 * bw)
            const s_Avmin1 = (Av * fyt) / (0.062 * Math.sqrt(fc) * bw);
            const s_Avmin2 = (Av * fyt) / (0.35 * bw);
            const s_max_Av = Math.min(s_Avmin1, s_Avmin2);

            // Absolute Max Spacing allowed for the chosen bar
            const s_max_governing = Math.min(s_max_code, s_max_Av);

            // 7. Calculate Spacing at Zones
            // Zone 1: Critical Section (d from support)
            let s_req_critical = 9999;
            if (Vs_req > 0) {
                // s = (Av fyt d) / Vs
                s_req_critical = (Av * fyt * d) / (Vs_req * 1000); // Vs in N
            }
            
            // Apply Limits
            let s_design_critical = Math.min(s_req_critical, s_max_governing);
            
            // Round down to nearest 10mm or 25mm for realism
            s_design_critical = Math.floor(s_design_critical / 25) * 25;
            if (s_design_critical < 50) s_design_critical = 50; // Practical min spacing

            // Zone 2 Spacing (Max allowed by code/min steel)
            let s_design_max = Math.floor(s_max_governing / 25) * 25;
            if (s_design_max < 50) s_design_max = 50;

            // Determine Zone Extents
            const x_strength_limit = Math.max(0, (Vu_support - phiVc) / wu); // meters
            const x_no_stirrups = Math.max(0, (Vu_support - halfPhiVc) / wu); // meters

            // Total Stirrups Check (Congestion)
            let totalStirrupsHalf = 0;
            let tempX = 0.05;
            while (tempX < Ln / 2) {
                totalStirrupsHalf++;
                let currentS = (tempX <= x_strength_limit) ? s_design_critical : s_design_max;
                tempX += (currentS / 1000);
            }
            const totalStirrupsFull = totalStirrupsHalf * 2;
            const isCongested = s_design_critical < 75 || totalStirrupsFull > (Ln * 10);

            // 8. Generate Summary HTML
            let summary = "";

            // Card 1: Section Capacity
            const sectionPass = !isSectionTooSmall;
            summary += `
                <div class="check-card ${sectionPass ? 'pass' : 'fail'}">
                    <h3>1. Section Capacity Check <span>${sectionPass ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-circle-xmark"></i>'}</span></h3>
                    <div class="math-block">
                        $$V_{s,max} = 0.66 \\sqrt{f'_c} b_w d = ${Vs_max_allowed.toFixed(1)} \\text{ kN}$$
                        $$V_{s,req} = ${Vs_req.toFixed(1)} \\text{ kN}$$
                    </div>
                    ${!sectionPass ? '<div class="warning-box"><i class="fa-solid fa-lightbulb"></i> <strong>Recommendation:</strong> Section is too small to resist shear. Increase beam width ($b_w$) or total height ($h$).</div>' : ''}
                </div>
            `;

            // Card 2: Concrete Contribution
            summary += `
                <div class="check-card pass">
                    <h3>2. Concrete Contribution ($\\phi V_c$) <span><i class="fa-solid fa-circle-check"></i></span></h3>
                    <div class="math-block">
                        $$\\phi V_c = 0.75 \\times 0.17 \\lambda \\sqrt{f'_c} b_w d = ${phiVc.toFixed(1)} \\text{ kN}$$
                        $$0.5 \\phi V_c = ${halfPhiVc.toFixed(1)} \\text{ kN}$$
                    </div>
                </div>
            `;

            // Card 3: Reinforcement Design & Congestion
            const spacingPass = !isCongested;
            summary += `
                <div class="check-card ${spacingPass ? 'pass' : 'warn'}">
                    <h3>3. Reinforcement & Congestion <span>${spacingPass ? '<i class="fa-solid fa-circle-check"></i>' : '<i class="fa-solid fa-triangle-exclamation"></i>'}</span></h3>
                    <ul class="result-list" style="margin-top:10px;">
                        <li><strong>Zone 1 Spacing:</strong> ${s_design_critical} mm</li>
                        <li><strong>Zone 2/3 Spacing:</strong> ${s_design_max} mm</li>
                        <li><strong>Total Stirrups:</strong> ~${totalStirrupsFull} per span</li>
                    </ul>
                    ${isCongested ? `<div class="warning-box"><i class="fa-solid fa-lightbulb"></i> <strong>Recommendation:</strong> ${s_design_critical < 75 ? 'Spacing is tight. ' : 'High stirrup count. '}Consider using a larger bar size or 4 legs to increase spacing and reduce congestion.</div>` : ''}
                </div>
            `;

            // Final Detailing Table
            summary += `
                <div class="summary-item" style="background-color: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 1rem; border: 1px solid #bfdbfe;">
                    <h4 style="margin-bottom: 0.75rem; color: #1e40af;">Final Detailing Schedule</h4>
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                        <tr style="border-bottom:1px solid #bfdbfe;"><td style="padding:8px; font-weight:600;">Stirrup Size</td><td style="padding:8px;">${getBarName(barArea)}</td></tr>
                        <tr style="border-bottom:1px solid #bfdbfe;"><td style="padding:8px; font-weight:600;">Number of Legs</td><td style="padding:8px;">${legs}</td></tr>
                        <tr style="border-bottom:1px solid #bfdbfe;"><td style="padding:8px; font-weight:600;">Zone 1 (0 to ${x_strength_limit.toFixed(2)}m)</td><td style="padding:8px; color: #1d4ed8; font-weight:700;">@ ${s_design_critical} mm</td></tr>
                        <tr style="border-bottom:1px solid #bfdbfe;"><td style="padding:8px; font-weight:600;">Zone 2/3 (Rest of span)</td><td style="padding:8px;">@ ${s_design_max} mm</td></tr>
                        <tr><td style="padding:8px; font-weight:600;">Steel $f_{yt}$</td><td style="padding:8px;">${fyt} MPa</td></tr>
                    </table>
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = summary;
            
            // Re-render Latex
            MathJax.typesetPromise();

            // 9. Visualize
            drawBeam(bw, h, cover, d, Ln, s_design_critical, s_design_max, x_strength_limit, x_no_stirrups);
            drawIsometric(bw, h, cover, Ln, s_design_critical, s_design_max, x_strength_limit, x_no_stirrups, legs);
        }

        function getBarName(area) {
            if (area == 50) return "8 mm";
            if (area == 79) return "10 mm";
            if (area == 113) return "12 mm";
            return "Custom";
        }

        function drawBeam(bw, h, cover, d, Ln_m, s1, s2, x1_m, x2_m) {
            const canvas = document.getElementById('beamCanvas');
            const ctx = canvas.getContext('2d');
            
            // Handle high resolution screens
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            
            if (rect.width === 0) return;

            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.height;

            // Clear
            ctx.clearRect(0, 0, width, height);

            // Draw Beam (Profile View - Half Span)
            const startX = 30;
            const beamW = width - 60;
            const beamH = Math.min(height * 0.5, 100); 
            const beamY = (height - beamH) / 2 + 10; 

            // Draw Concrete
            ctx.fillStyle = '#e2e8f0';
            ctx.fillRect(startX, beamY, beamW, beamH);
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, beamY, beamW, beamH);

            // Draw Centerline Break
            ctx.beginPath();
            ctx.moveTo(startX + beamW, beamY - 10);
            ctx.lineTo(startX + beamW, beamY + beamH + 10);
            ctx.strokeStyle = '#94a3b8';
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '10px Inter';
            ctx.textAlign = 'right';
            ctx.fillText("Centerline", startX + beamW - 5, beamY + beamH + 15);

            // Draw Support
            ctx.fillStyle = '#94a3b8';
            ctx.fillRect(startX - 10, beamY + beamH, 20, 10);

            // Dimensions Setup
            // Map real meters to pixels (Only drawing half span)
            const pixelPerMeter = beamW / (Ln_m / 2);

            // Draw Stirrups
            ctx.strokeStyle = '#ef4444'; // Red for stirrups
            ctx.lineWidth = 1.5;

            let currentX_m = 0.05; // Start 50mm from support
            
            // Draw loop
            while (currentX_m < Ln_m / 2) {
                let pixelX = startX + (currentX_m * pixelPerMeter);
                
                // Determine spacing based on zone
                let currentSpacing_mm;
                if (currentX_m <= x1_m) currentSpacing_mm = s1;
                else currentSpacing_mm = s2;

                if (pixelX < startX + beamW) {
                    ctx.strokeStyle = '#ef4444';
                    // Draw vertical stirrup line
                    ctx.beginPath();
                    ctx.moveTo(pixelX, beamY + 5); 
                    ctx.lineTo(pixelX, beamY + beamH - 5); 
                    ctx.stroke();
                }

                currentX_m += (currentSpacing_mm / 1000);
            }

            // Draw Dimensions Annotations
            ctx.fillStyle = '#0f172a';
            ctx.font = '10px Inter';
            ctx.textAlign = 'center';
            
            // Zone 1 Line
            const z1_pixel = startX + (x1_m * pixelPerMeter);
            if (z1_pixel > startX) {
                drawDimensionLine(ctx, startX, beamY - 20, z1_pixel, beamY - 20, `Zone 1: @${s1}mm`);
            }
            
            // Zone 2 Line
            const z2_pixel = startX + (x2_m * pixelPerMeter);
            if (z2_pixel > z1_pixel) {
                drawDimensionLine(ctx, z1_pixel, beamY - 20, Math.min(startX + beamW, z2_pixel), beamY - 20, `Zone 2: @${s2}mm`);
            }

            // Zone 3 Line
            if (startX + beamW > z2_pixel) {
                drawDimensionLine(ctx, Math.max(startX, z2_pixel), beamY - 20, startX + beamW, beamY - 20, `Zone 3: @${s2}mm`);
            }

            // Draw Critical Section Line
            const d_m = d / 1000;
            const d_pixel = startX + (d_m * pixelPerMeter);
            ctx.strokeStyle = '#3b82f6';
            ctx.setLineDash([2, 2]);
            ctx.beginPath();
            ctx.moveTo(d_pixel, beamY);
            ctx.lineTo(d_pixel, beamY + beamH);
            ctx.stroke();
            ctx.fillStyle = '#3b82f6';
            ctx.textAlign = 'left';
            ctx.fillText("Crit. Section (d)", d_pixel + 5, beamY + beamH - 10);
            ctx.setLineDash([]);
        }

        function drawIsometric(bw, h, cover, Ln_m, s1, s2, x1_m, x2_m, legs) {
            const canvas = document.getElementById('isoCanvas');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const width = rect.width;
            const height = rect.height;
            ctx.clearRect(0, 0, width, height);

            // Projection parameters (True 30-degree Isometric)
            const viewL_mm = (Ln_m / 2) * 1000;
            const scale = Math.min(width / (viewL_mm * 1.2), height / (h * 2.5));
            const ox = width * 0.2;
            const oy = height * 0.3;

            function project(x, y, z) {
                // x: along beam (mm), y: width (mm), z: height (mm) - z=0 is bottom
                return {
                    px: ox + (x - y) * 0.866 * scale,
                    py: oy + (x + y) * 0.5 * scale - z * scale
                };
            }

            // Draw Concrete Wireframe (Faint)
            ctx.strokeStyle = 'rgba(51, 65, 85, 0.1)';
            ctx.lineWidth = 1;
            const corners = [
                [0, 0, 0], [viewL_mm, 0, 0], [viewL_mm, bw, 0], [0, bw, 0],
                [0, 0, h], [viewL_mm, 0, h], [viewL_mm, bw, h], [0, bw, h]
            ].map(p => project(...p));

            // Bottom
            ctx.beginPath(); ctx.moveTo(corners[0].px, corners[0].py);
            ctx.lineTo(corners[1].px, corners[1].py); ctx.lineTo(corners[2].px, corners[2].py);
            ctx.lineTo(corners[3].px, corners[3].py); ctx.closePath(); ctx.stroke();
            // Top
            ctx.beginPath(); ctx.moveTo(corners[4].px, corners[4].py);
            ctx.lineTo(corners[5].px, corners[5].py); ctx.lineTo(corners[6].px, corners[6].py);
            ctx.lineTo(corners[7].px, corners[7].py); ctx.closePath(); ctx.stroke();
            // Verticals
            for(let i=0; i<4; i++) {
                ctx.beginPath(); ctx.moveTo(corners[i].px, corners[i].py);
                ctx.lineTo(corners[i+4].px, corners[i+4].py); ctx.stroke();
            }

            // Draw Stirrups
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 1.5;
            let currentX_m = 0.05;

            while (currentX_m < Ln_m / 2) {
                const x_mm = currentX_m * 1000;
                const s_corners = [
                    [x_mm, cover, cover], [x_mm, bw - cover, cover],
                    [x_mm, bw - cover, h - cover], [x_mm, cover, h - cover]
                ].map(p => project(...p));
                
                ctx.beginPath();
                ctx.moveTo(s_corners[0].px, s_corners[0].py);
                s_corners.forEach(p => ctx.lineTo(p.px, p.py));
                ctx.closePath();
                ctx.stroke();

                if (legs == 4) {
                    const y1 = cover + (bw - 2*cover)/3;
                    const y2 = cover + 2*(bw - 2*cover)/3;
                    const p1 = project(x_mm, y1, cover); const p2 = project(x_mm, y1, h - cover);
                    ctx.beginPath(); ctx.moveTo(p1.px, p1.py); ctx.lineTo(p2.px, p2.py); ctx.stroke();
                    const p3 = project(x_mm, y2, cover); const p4 = project(x_mm, y2, h - cover);
                    ctx.beginPath(); ctx.moveTo(p3.px, p3.py); ctx.lineTo(p4.px, p4.py); ctx.stroke();
                }

                let currentSpacing_mm = (currentX_m <= x1_m) ? s1 : s2;
                currentX_m += (currentSpacing_mm / 1000);
            }

            // Draw Longitudinal Bars (4 corners)
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            [[cover, cover], [bw-cover, cover], [bw-cover, h-cover], [cover, h-cover]].forEach(corner => {
                const pStart = project(0, corner[0], corner[1]);
                const pEnd = project(viewL_mm, corner[0], corner[1]);
                ctx.beginPath(); ctx.moveTo(pStart.px, pStart.py); ctx.lineTo(pEnd.px, pEnd.py); ctx.stroke();
            });
        }

        function drawDimensionLine(ctx, x1, y, x2, y, text) {
            ctx.strokeStyle = '#0f172a';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(x1, y);
            ctx.lineTo(x2, y);
            
            // Ticks
            ctx.moveTo(x1, y-3);
            ctx.lineTo(x1, y+3);
            ctx.moveTo(x2, y-3);
            ctx.lineTo(x2, y+3);
            ctx.stroke();

            // Text
            const mid = (x1 + x2) / 2;
            ctx.textAlign = 'center';
            ctx.fillText(text, mid, y - 5);
        }

        // Initialize
        window.onload = function() {
            // Attach listeners to all inputs for live update
            document.querySelectorAll('.input-panel input, .input-panel select').forEach(el => {
                el.addEventListener('input', calculateShear);
            });
            calculateShear();
        };

    </script>
</body>
</html>