<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC Design Suite | T-Beam Calculator</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- MathJax for Latex -->
    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Three.js for 3D Visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* Layout Grid */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        .tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            margin-bottom: -2px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        /* Visualization */
        .viz-card {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        svg { width: 100%; height: 100%; max-height: 400px; }
        
        /* Text/Label Styles within SVG */
        .dim-text { font-size: 12px; fill: #64748b; font-family: sans-serif; }
        .bar-label { font-size: 14px; font-weight: bold; fill: #ef4444; }
        .section-fill { fill: #e2e8f0; stroke: #334155; stroke-width: 2; }
        .stirrup-stroke { fill: none; stroke: #3b82f6; stroke-width: 2; stroke-dasharray: 4; }
        .rebar-fill { fill: #ef4444; stroke: #7f1d1d; stroke-width: 1; }
        .dim-line { stroke: #64748b; stroke-width: 1; }

        .latex-output {
            margin-top: 1rem;
            font-size: 1rem;
        }

        .status-box {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #991b1b; }
        .status-warning { background: #fef3c7; color: #92400e; }

        .alert-box {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .alert-warning { background-color: #fffbeb; border-left: 4px solid var(--warning); color: #b45309; }
        .alert-danger { background-color: #fef2f2; border-left: 4px solid var(--error); color: #991b1b; }

        .result-list {
            list-style: none;
            padding: 0;
            margin-bottom: 1rem;
        }
        .result-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .hidden { display: none; }

        @media (max-width: 1024px) {
            .grid-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <svg style="display: none;">
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#64748b" /></marker>
        </defs>
    </svg>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <a href="index.html" class="back-btn">
            <i class="fa-solid fa-arrow-left"></i> Dashboard
        </a>

        <div class="input-panel">
            <h2 class="panel-title">T-Beam Properties</h2>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('design')">Design</div>
            <div class="tab" onclick="switchTab('analysis')">Analysis</div>
        </div>

        <form id="calcForm">
            <!-- Geometry Section -->
            <div class="section-header">Geometry</div>
            <div class="form-row">
                <div class="form-col">
                    <label>Flange Width, $b_{eff}$ (mm)</label>
                    <input type="number" id="beff" value="600" min="100">
                </div>
                <div class="form-col">
                    <label>Flange Thick., $h_f$ (mm)</label>
                    <input type="number" id="hf" value="100" min="50">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label>Web Width, $b_w$ (mm)</label>
                    <input type="number" id="bw" value="300" min="100">
                </div>
                <div class="form-col">
                    <label>Total Height, $h$ (mm)</label>
                    <input type="number" id="h" value="500" min="200">
                </div>
            </div>
            <div class="form-group">
                <label>Concrete Cover (mm)</label>
                <input type="number" id="cover" value="40">
            </div>

            <!-- Material Properties -->
            <div class="section-header">Materials</div>
            <div class="form-row">
                <div class="form-col">
                    <label>$f'_c$ (MPa)</label>
                    <input type="number" id="fc" value="28">
                </div>
                <div class="form-col">
                    <label>$f_y$ (MPa)</label>
                    <input type="number" id="fy" value="420">
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label>Stirrup $\phi$ (mm)</label>
                    <select id="stirrupSize">
                        <option value="8">8 mm</option>
                        <option value="10" selected>10 mm</option>
                        <option value="12">12 mm</option>
                    </select>
                </div>
            </div>

            <!-- DESIGN TAB INPUTS -->
            <div id="designInputs">
                <div class="section-header">Loading (Design)</div>
                <div class="form-group">
                    <label>Factored Moment, $M_u$ (kNm)</label>
                    <input type="number" id="Mu" value="350">
                </div>
                <div class="form-group">
                    <label>Preferred Bar Size</label>
                    <select id="designBarSize">
                        <option value="16">16 mm</option>
                        <option value="20">20 mm</option>
                        <option value="25" selected>25 mm</option>
                        <option value="28">28 mm</option>
                        <option value="32">32 mm</option>
                    </select>
                </div>
            </div>

            <!-- ANALYSIS TAB INPUTS -->
            <div id="analysisInputs" class="hidden">
                <div class="section-header">Reinforcement (Analysis)</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Qty Tension Bars</label>
                        <input type="number" id="nbars" value="4">
                    </div>
                    <div class="form-col">
                        <label>Bar Size (mm)</label>
                        <select id="analysisBarSize">
                            <option value="16">16 mm</option>
                            <option value="20">20 mm</option>
                            <option value="25" selected>25 mm</option>
                            <option value="28">28 mm</option>
                            <option value="32">32 mm</option>
                        </select>
                    </div>
                </div>
            </div>

            <button type="button" class="calc-btn" onclick="calculate()">Calculate</button>
            </form>
        </div>
    </nav>

    <!-- 3D Modal -->
    <div id="modal3d" class="modal">
        <div class="modal-content" style="width: 90%; height: 85vh;">
            <div class="modal-header">
                <h3 style="margin:0;">3D Reinforcement Cage Model</h3>
                <button onclick="close3DModal()" class="close-btn">&times;</button>
            </div>
            <div id="threeContainer" style="flex: 1; width: 100%; background: #f0f2f5;"></div>
            <div style="padding: 10px; background: #1e293b; color: white; font-size: 0.8rem; text-align: center;">
                <i class="fa-solid fa-mouse"></i> Left Click: Rotate | Scroll: Zoom | Right Click: Pan
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Hero Section -->
        <div class="hero">
            <h1>T-Beam Design & Analysis</h1>
            <p>Calculate flexural capacity and required reinforcement for T-shaped concrete sections based on ACI 318M-11.</p>
        </div>

        <div class="grid-container">
            <div class="viz-container">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
                    Section Detail
                    <button onclick="open3DModal()" class="calc-btn" style="margin:0; padding: 5px 12px; font-size: 0.8rem; width: auto;">
                        <i class="fa-solid fa-cube"></i> View 3D Cage
                    </button>
                </div>
                <div class="viz-card">
                    <svg id="beamSvg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet">
                        <text x="50%" y="50%" text-anchor="middle" fill="#94a3b8">Enter parameters and click Calculate</text>
                    </svg>
                </div>
            </div>

            <div class="results-content">
                <div class="section-header">Calculation Summary</div>
                <div id="alert-area"></div>
                <div class="card">
                    <div id="resultOutput">
                        <p style="color: var(--text-muted); font-style: italic;">Enter parameters and click calculate to see results.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<script>
    let currentMode = 'design';
    let lastSvgData = null;

    function switchTab(mode) {
        currentMode = mode;
        const tabs = document.querySelectorAll('.tab');
        const designDiv = document.getElementById('designInputs');
        const analysisDiv = document.getElementById('analysisInputs');
        
        document.getElementById('resultOutput').innerHTML = '<p style="color: #94a3b8; font-style: italic;">Enter parameters and click calculate to see results.</p>';
        document.getElementById('alert-area').innerHTML = '';
        clearSvg();

        tabs.forEach(t => t.classList.remove('active'));
        if(mode === 'design') {
            tabs[0].classList.add('active');
            designDiv.classList.remove('hidden');
            analysisDiv.classList.add('hidden');
        } else {
            tabs[1].classList.add('active');
            designDiv.classList.add('hidden');
            analysisDiv.classList.remove('hidden');
        }
    }

    function getBeta1(fc) {
        if (fc <= 28) return 0.85;
        let beta = 0.85 - 0.05 * (fc - 28) / 7;
        return Math.max(0.65, beta);
    }

    function clearSvg() {
        const svg = document.getElementById('beamSvg');
        while (svg.firstChild) { svg.removeChild(svg.firstChild); }
        svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#94a3b8">Enter parameters and click Calculate</text>';
    }

    // --- CALCULATION ENGINE ---
    function calculate() {
        // Gather Inputs
        const beff = parseFloat(document.getElementById('beff').value);
        const hf = parseFloat(document.getElementById('hf').value);
        const bw = parseFloat(document.getElementById('bw').value);
        const h = parseFloat(document.getElementById('h').value);
        const cover = parseFloat(document.getElementById('cover').value);
        const fc = parseFloat(document.getElementById('fc').value);
        const fy = parseFloat(document.getElementById('fy').value);
        const stirrupDia = parseFloat(document.getElementById('stirrupSize').value);
        const beta1 = getBeta1(fc);

        const resultDiv = document.getElementById('resultOutput');
        const alertArea = document.getElementById('alert-area');
        alertArea.innerHTML = "";
        let svgData = {};

        // Validation - Basic Geometry
        if (bw >= beff) {
             resultDiv.innerHTML = `<div class="status-box status-error"><i class="fas fa-exclamation-triangle"></i> Error: Web width ($b_w$) must be less than Flange width ($b_{eff}$).</div>`;
             MathJax.typesetPromise();
             return;
        }

        const phi_assumed = 0.9;
        const Es = 200000;
        const eps_u = 0.003;
        const minSpacing = Math.max(25, 25); // Standard min spacing

        let d = h - cover - stirrupDia - 25/2; // Initial estimate
        let tensionLayers = [];
        let n_layers = 1;
        let behavior = "";
        let a_calc = 0;
        let As_req = 0;
        let numBars = 0;
        let barDia = 0;
        let phi = 0.9;
        let Mn = 0;

        if (currentMode === 'design') {
            const Mu_kNm = parseFloat(document.getElementById('Mu').value);
            const Mu = Mu_kNm * 1e6;
            barDia = parseFloat(document.getElementById('designBarSize').value);
            const areaOneBar = (Math.PI * barDia * barDia) / 4;
            const clearWidth = bw - 2*cover - 2*stirrupDia;
            const n_max_per_layer = Math.floor((clearWidth + Math.max(25, barDia)) / (barDia + Math.max(25, barDia)));

            for (let iter = 0; iter < 5; iter++) {
                const Mn_flange_limit = 0.85 * fc * beff * hf * (d - hf/2);
                const Mu_flange_limit = phi_assumed * Mn_flange_limit;

                if (Mu <= Mu_flange_limit) {
                    behavior = "Rectangular Behavior ($a \\le h_f$)";
                    const Rn = Mu / (phi_assumed * beff * d * d);
                    const m = fy / (0.85 * fc);
                    const rho = (1/m) * (1 - Math.sqrt(Math.max(0, 1 - (2 * m * Rn) / fy)));
                    As_req = rho * beff * d;
                    a_calc = (As_req * fy) / (0.85 * fc * beff);
                } else {
                    behavior = "True T-Beam Behavior ($a > h_f$)";
                    const Asf = (0.85 * fc * (beff - bw) * hf) / fy;
                    const Muf = phi_assumed * Asf * fy * (d - hf/2);
                    const Muw = Mu - Muf;
                    const Rnw = Muw / (phi_assumed * bw * d * d);
                    const m = fy / (0.85 * fc);
                    const rhow = (1/m) * (1 - Math.sqrt(Math.max(0, 1 - (2 * m * Rnw) / fy)));
                    const Asw = rhow * bw * d;
                    As_req = Asf + Asw;
                    a_calc = (Asw * fy) / (0.85 * fc * bw);
                }

                const As_min = Math.max(0.25 * Math.sqrt(fc) / fy * bw * d, 1.4 * bw * d / fy);
                if (As_req < As_min) As_req = As_min;

                numBars = Math.ceil(As_req / areaOneBar);
                const new_n_layers = Math.ceil(numBars / n_max_per_layer);
                
                let sum_yi_ni = 0;
                let temp_layers = [];
                let remainingBars = numBars;
                for (let i = 0; i < new_n_layers; i++) {
                    const count = Math.min(remainingBars, n_max_per_layer);
                    const yi = h - cover - stirrupDia - barDia/2 - i * (barDia + Math.max(25, barDia));
                    sum_yi_ni += count * yi;
                    temp_layers.push({y: yi, count: count});
                    remainingBars -= count;
                }
                const new_d = sum_yi_ni / numBars;

                if (Math.abs(new_d - d) < 0.1 && new_n_layers === n_layers) {
                    d = new_d;
                    tensionLayers = temp_layers;
                    n_layers = new_n_layers;
                    break;
                }
                d = new_d;
                tensionLayers = temp_layers;
                n_layers = new_n_layers;
            }

            if (n_layers > 1) {
                alertArea.innerHTML = `<div class="alert-box alert-warning"><i class="fas fa-layer-group"></i> Multi-layer reinforcement required (d = ${d.toFixed(1)} mm).</div>`;
            }
            Mn = Mu / phi_assumed;

            svgData = { beff, hf, bw, h, cover, stirrupDia, barDia, numBars, tensionLayers, d, mode: 'design' };
            lastSvgData = svgData;

        } else {
            numBars = parseInt(document.getElementById('nbars').value);
            barDia = parseFloat(document.getElementById('analysisBarSize').value);
            const areaOneBar = (Math.PI * barDia * barDia) / 4;
            const As = numBars * areaOneBar;
            
            const clearWidth = bw - 2*cover - 2*stirrupDia;
            const n_max_per_layer = Math.max(1, Math.floor((clearWidth + Math.max(25, barDia)) / (barDia + Math.max(25, barDia))));
            n_layers = Math.ceil(numBars / n_max_per_layer);
            
            let sum_yi_ni = 0;
            let remainingBars = numBars;
            for (let i = 0; i < n_layers; i++) {
                const count = Math.min(remainingBars, n_max_per_layer);
                const yi = h - cover - stirrupDia - barDia/2 - i * (barDia + Math.max(25, barDia));
                sum_yi_ni += count * yi;
                tensionLayers.push({y: yi, count: count});
                remainingBars -= count;
            }
            d = sum_yi_ni / numBars;

            let a = (As * fy) / (0.85 * fc * beff);
            if (a <= hf) {
                behavior = "Rectangular Behavior ($a \\le h_f$)";
                Mn = As * fy * (d - a/2);
            } else {
                behavior = "T-Beam Behavior ($a > h_f$)";
                const Asf = (0.85 * fc * (beff - bw) * hf) / fy;
                const Mnf = Asf * fy * (d - hf/2);
                const Asw = As - Asf;
                a = (Asw * fy) / (0.85 * fc * bw);
                const Mnw = Asw * fy * (d - a/2);
                Mn = Mnf + Mnw;
            }

            const c = a / beta1;
            const epsilon_t = eps_u * (d - c) / c;
            phi = 0.9;
            if (epsilon_t < 0.002) {
                phi = 0.65;
                alertArea.innerHTML = `<div class="alert-box alert-danger"><i class="fas fa-exclamation-circle"></i> Compression controlled section ($\epsilon_t < 0.002$). Not permitted for beams.</div>`;
            } else if (epsilon_t < 0.005) {
                phi = 0.65 + 0.25 * (epsilon_t - 0.002) / 0.003;
                alertArea.innerHTML = `<div class="alert-box alert-warning"><i class="fas fa-exclamation-triangle"></i> Transition zone section ($0.002 < \epsilon_t < 0.005$). $\phi = ${phi.toFixed(3)}$.</div>`;
            }
            a_calc = a;

            svgData = { beff, hf, bw, h, cover, stirrupDia, barDia, numBars, tensionLayers, d, mode: 'analysis' };
            lastSvgData = svgData;
        }

        // --- RENDER RESULTS ---
        let resultsHTML = "";
        const areaOneBar = (Math.PI * barDia * barDia) / 4;
        const c = a_calc / beta1;
        const epsilon_t = eps_u * (d - c) / c;

        // --- STATUS BADGE & ALERTS ---
        let statusClass = "status-success";
        let statusText = "Design Satisfactory";
        if (epsilon_t < 0.004) {
            statusClass = "status-error";
            statusText = "Code Violation: Brittle Section";
            alertArea.innerHTML += `<div class="alert-box alert-danger"><i class="fas fa-times-circle"></i> <strong>Brittle Section:</strong> Tensile strain $\\epsilon_t$ (${epsilon_t.toFixed(4)}) is less than 0.004. Not permitted for beams.</div>`;
        } else if (epsilon_t < 0.005) {
            statusClass = "status-warning";
            statusText = "Transition Zone";
            alertArea.innerHTML += `<div class="alert-box alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Transition Zone:</strong> $0.002 < \\epsilon_t < 0.005$. $\\phi$ is reduced to ${phi.toFixed(3)}.</div>`;
        }

        if (currentMode === 'analysis') {
            const As_min = Math.max(0.25 * Math.sqrt(fc) / fy * bw * d, 1.4 * bw * d / fy);
            if (numBars * areaOneBar < As_min) {
                alertArea.innerHTML += `<div class="alert-box alert-danger"><i class="fas fa-exclamation-circle"></i> <strong>$A_{s,min}$ Violation:</strong> Provided steel (${(numBars * areaOneBar).toFixed(0)} mm²) is less than ACI 318 minimum (${As_min.toFixed(0)} mm²).</div>`;
            }
        }

        resultsHTML += `<div class="status-box ${statusClass}"><i class="fas ${statusClass === 'status-error' ? 'fa-times-circle' : (statusClass === 'status-warning' ? 'fa-exclamation-triangle' : 'fa-check-circle')}"></i> ${statusText}</div>`;

        resultsHTML += `<h3>${currentMode === 'design' ? 'Design' : 'Analysis'} Results</h3><ul class="result-list">`;
        resultsHTML += `<li><strong>Behavior:</strong> ${behavior}</li>`;
        if (currentMode === 'design') resultsHTML += `<li><strong>Required $A_s$:</strong> ${As_req.toFixed(0)} mm²</li>`;
        resultsHTML += `<li><strong>Provided:</strong> ${numBars} - ϕ${barDia} (${(numBars * areaOneBar).toFixed(0)} mm²)</li>`;
        resultsHTML += `<li><strong>Nominal Moment ($M_n$):</strong> ${(Mn/1e6).toFixed(1)} kNm</li>`;
        resultsHTML += `<li><strong>Design Moment ($\phi M_n$):</strong> ${(phi * Mn / 1e6).toFixed(1)} kNm</li>`;
        resultsHTML += `</ul>`;

        let scheduleHTML = `<h4 style="margin-top:1.5rem; margin-bottom:0.5rem;">Reinforcement Schedule</h4>
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">`;
        tensionLayers.forEach((layer, idx) => {
            const dist = layer.y - d;
            scheduleHTML += `<tr style="border-bottom:1px solid #eee;">
                <td style="padding:5px; font-weight:600;">Tension Layer ${idx + 1}</td>
                <td style="padding:5px;">${layer.count} - ϕ${barDia} (Dist to $d_{centroid}$: ${dist > 0 ? '+' : ''}${dist.toFixed(1)} mm)</td>
            </tr>`;
        });
        scheduleHTML += `
                <tr style="border-bottom:1px solid #eee;"><td style="padding:5px; font-weight:600;">Concrete $f'_c$</td><td style="padding:5px;">${fc} MPa</td></tr>
                <tr style="border-bottom:1px solid #eee;"><td style="padding:5px; font-weight:600;">Steel $f_y$</td><td style="padding:5px;">${fy} MPa</td></tr>
                <tr style="border-bottom:1px solid #eee;"><td style="padding:5px; font-weight:600;">Effective Width $b_{eff}$</td><td style="padding:5px;">${beff} mm</td></tr>
                <tr style="border-bottom:1px solid #eee;"><td style="padding:5px; font-weight:600;">Web Width $b_w$</td><td style="padding:5px;">${bw} mm</td></tr>
            </table>`;

        resultsHTML += scheduleHTML + `
            <div class="latex-output">
                $$ d_{centroid} = ${d.toFixed(1)} \\text{ mm} $$
                $$ \\epsilon_t = ${epsilon_t.toFixed(4)} $$
                $$ a = ${a_calc.toFixed(2)} \\text{ mm} $$
            </div>`;

        resultDiv.innerHTML = resultsHTML;
        
        MathJax.typesetPromise();
        drawBeam(svgData);
    }

    // --- VISUALIZATION ENGINE ---
    function drawBeam(data) {
        const svg = document.getElementById('beamSvg');
        
        // Clear previous
        while (svg.firstChild) { svg.removeChild(svg.firstChild); }

        // Scale Factor Calculation
        // We want to fit the beam in a 400x400 viewbox with padding
        const padding = 60;
        const viewW = 500;
        const viewH = 500;
        
        const scaleX = (viewW - padding*2) / data.beff;
        const scaleY = (viewH - padding*2) / data.h;
        const scale = Math.min(scaleX, scaleY);

        // Center the drawing
        const drawW = data.beff * scale;
        const drawH = data.h * scale;
        const startX = (viewW - drawW) / 2;
        const startY = (viewH - drawH) / 2;

        // --- 1. Draw Concrete Section (T-Shape) ---
        // Points: TopLeft, TopRight, FlangeBotRight, WebBotRight, WebBotLeft, FlangeBotLeft
        // Coordinates relative to startX, startY
        const flangeH_scaled = data.hf * scale;
        const webW_scaled = data.bw * scale;
        const totalH_scaled = data.h * scale;
        const totalW_scaled = data.beff * scale;
        const flangeOverhang = (totalW_scaled - webW_scaled) / 2;

        const pathData = `
            M ${startX},${startY} 
            H ${startX + totalW_scaled} 
            V ${startY + flangeH_scaled} 
            H ${startX + totalW_scaled - flangeOverhang} 
            V ${startY + totalH_scaled} 
            H ${startX + flangeOverhang} 
            V ${startY + flangeH_scaled} 
            H ${startX} 
            Z
        `;

        const concretePath = createSVGElement('path', {
            d: pathData,
            class: 'section-fill'
        });
        svg.appendChild(concretePath);

        // --- 2. Draw Stirrup (Outline in Web) ---
        const coverSc = data.cover * scale;
        const stirrupYTop = startY + coverSc; // Assuming closed stirrup goes to top
        // For T-beam, stirrup usually sits in web. Let's simplify: Stirrup in Web portion.
        // Stirrup Width = bw - 2*cover
        // Stirrup Height = h - 2*cover
        const sLeft = startX + flangeOverhang + coverSc;
        const sWidth = webW_scaled - 2*coverSc;
        const sHeight = totalH_scaled - 2*coverSc; // From bottom to top
        // Note: In T-Beams, stirrup usually extends into flange. Let's draw it full height - cover.
        
        const stirrupRect = createSVGElement('rect', {
            x: sLeft,
            y: startY + coverSc,
            width: sWidth,
            height: sHeight,
            rx: 5,
            class: 'stirrup-stroke'
        });
        svg.appendChild(stirrupRect);

        // --- 3. Draw Longitudinal Bars ---
        const barRad = (data.barDia * scale) / 2;
        const barsStartX = sLeft + (data.stirrupDia * scale) + barRad;
        const availableWidth = sWidth - 2*(data.stirrupDia * scale) - 2*barRad;

        data.tensionLayers.forEach(layer => {
            const barY = startY + layer.y * scale;
            const gap = layer.count > 1 ? availableWidth / (layer.count - 1) : 0;
            for(let i=0; i<layer.count; i++) {
                const cx = (layer.count > 1) ? barsStartX + (i * gap) : startX + totalW_scaled/2;
                const circle = createSVGElement('circle', { cx, cy: barY, r: barRad, class: 'rebar-fill' });
                svg.appendChild(circle);
            }
        });

        // --- 4. Dimensions & Annotations ---
        
        // b_eff dimension (Top)
        drawDimension(svg, startX, startY - 15, startX + totalW_scaled, startY - 15, `b_eff = ${data.beff}`);
        
        // h dimension (Left)
        drawDimension(svg, startX - 15, startY, startX - 15, startY + totalH_scaled, `h = ${data.h}`, true);

        // hf dimension (Right)
        drawDimension(svg, startX + totalW_scaled + 15, startY, startX + totalW_scaled + 15, startY + flangeH_scaled, `hf = ${data.hf}`, true);

        // bw dimension (Bottom)
        drawDimension(svg, startX + flangeOverhang, startY + totalH_scaled + 15, startX + flangeOverhang + webW_scaled, startY + totalH_scaled + 15, `bw = ${data.bw}`);

        // d_centroid dimension (Left, offset)
        drawDimension(svg, startX - 45, startY, startX - 45, startY + data.d * scale, `d_centroid = ${data.d.toFixed(1)}`, true);

        // Label Steel
        const labelText = createSVGElement('text', {
            x: startX + totalW_scaled/2,
            y: startY + totalH_scaled - coverSc - 30,
            'text-anchor': 'middle',
            class: 'bar-label'
        });
        labelText.textContent = `${data.numBars} - ϕ${data.barDia}`;
        svg.appendChild(labelText);
    }

    // Helper to create SVG elements
    function createSVGElement(tag, attrs) {
        const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
        for (const [key, value] of Object.entries(attrs)) {
            el.setAttribute(key, value);
        }
        return el;
    }

    // Helper for dimension lines
    function drawDimension(svg, x1, y1, x2, y2, text, isVertical = false) {
        // Line
        const line = createSVGElement('line', { x1, y1, x2, y2, class: 'dim-line' });
        svg.appendChild(line);

        // Ticks
        const tickSize = 4;
        if(isVertical) {
            svg.appendChild(createSVGElement('line', { x1: x1-tickSize, y1: y1, x2: x1+tickSize, y2: y1, class: 'dim-line' }));
            svg.appendChild(createSVGElement('line', { x1: x2-tickSize, y1: y2, x2: x2+tickSize, y2: y2, class: 'dim-line' }));
        } else {
            svg.appendChild(createSVGElement('line', { x1: x1, y1: y1-tickSize, x2: x1, y2: y1+tickSize, class: 'dim-line' }));
            svg.appendChild(createSVGElement('line', { x1: x2, y1: y2-tickSize, x2: x2, y2: y2+tickSize, class: 'dim-line' }));
        }

        // Text
        const textEl = createSVGElement('text', {
            x: (x1 + x2) / 2,
            y: (y1 + y2) / 2,
            'text-anchor': 'middle',
            'dominant-baseline': isVertical ? 'middle' : 'auto',
            class: 'dim-text'
        });
        
        if (isVertical) {
             textEl.setAttribute('transform', `rotate(-90, ${(x1+x2)/2}, ${(y1+y2)/2}) translate(0, -10)`);
        } else {
             textEl.setAttribute('dy', '-5');
        }
        
        textEl.textContent = text;
        svg.appendChild(textEl);
    }

    // --- 3D VISUALIZATION LOGIC ---
    let scene, camera, renderer, controls;

    function open3DModal() {
        if (!lastSvgData) {
            alert("Please calculate first to generate the model.");
            return;
        }
        document.getElementById('modal3d').style.display = 'flex';
        init3DScene();
    }

    function close3DModal() {
        document.getElementById('modal3d').style.display = 'none';
        if (renderer) {
            renderer.dispose();
            const container = document.getElementById('threeContainer');
            if (container.firstChild) container.removeChild(renderer.domElement);
        }
    }

    function init3DScene() {
        const container = document.getElementById('threeContainer');
        const width = container.clientWidth;
        const height = container.clientHeight;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f2f5);

        camera = new THREE.PerspectiveCamera(45, width / height, 10, 20000);
        camera.position.set(1500, 1000, 1500);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const sun = new THREE.DirectionalLight(0xffffff, 0.8);
        sun.position.set(1, 1, 1);
        scene.add(sun);

        const data = lastSvgData;
        const L = 2000; // Beam length for visualization

        // 1. Concrete T-Beam (Transparent)
        const flangeGeom = new THREE.BoxGeometry(data.beff, data.hf, L);
        const webGeom = new THREE.BoxGeometry(data.bw, data.h - data.hf, L);
        const concMat = new THREE.MeshPhongMaterial({ color: 0x94a3b8, transparent: true, opacity: 0.2 });
        
        const flange = new THREE.Mesh(flangeGeom, concMat);
        flange.position.set(0, data.h/2 - data.hf/2, 0);
        scene.add(flange);

        const web = new THREE.Mesh(webGeom, concMat);
        web.position.set(0, (data.h/2 - data.hf) - (data.h - data.hf)/2, 0);
        scene.add(web);

        // 2. Longitudinal Bars
        const barMat = new THREE.MeshPhongMaterial({ color: 0xef4444 });
        const barGeom = new THREE.CylinderGeometry(data.barDia/2, data.barDia/2, L, 8);
        barGeom.rotateX(Math.PI/2);

        data.tensionLayers.forEach(layer => {
            const y = data.h/2 - layer.y;
            const sWidth = data.bw - 2*data.cover;
            const barsStartX = -sWidth/2 + data.stirrupDia + data.barDia/2;
            const availableWidth = sWidth - 2*data.stirrupDia - data.barDia;
            const gap = layer.count > 1 ? availableWidth / (layer.count - 1) : 0;

            for(let i=0; i<layer.count; i++) {
                const bar = new THREE.Mesh(barGeom, barMat);
                const x = (layer.count > 1) ? barsStartX + (i * gap) : 0;
                bar.position.set(x, y, 0);
                scene.add(bar);
            }
        });

        // 3. Stirrups
        const stirrupMat = new THREE.MeshPhongMaterial({ color: 0x3b82f6 });
        const sW = data.bw - 2*data.cover;
        const sH = data.h - 2*data.cover;
        const stirrupSpacing = 200;
        
        for(let z = -L/2 + 100; z <= L/2 - 100; z += stirrupSpacing) {
            // Simplified stirrup as a thin box frame
            const cage = new THREE.Group();
            const legGeomV = new THREE.BoxGeometry(data.stirrupDia, sH, data.stirrupDia);
            const legGeomH = new THREE.BoxGeometry(sW, data.stirrupDia, data.stirrupDia);
            
            const left = new THREE.Mesh(legGeomV, stirrupMat);
            left.position.set(-sW/2, 0, 0);
            cage.add(left);
            
            const right = new THREE.Mesh(legGeomV, stirrupMat);
            right.position.set(sW/2, 0, 0);
            cage.add(right);
            
            const top = new THREE.Mesh(legGeomH, stirrupMat);
            top.position.set(0, sH/2, 0);
            cage.add(top);
            
            const bot = new THREE.Mesh(legGeomH, stirrupMat);
            bot.position.set(0, -sH/2, 0);
            cage.add(bot);
            
            cage.position.set(0, 0, z);
            scene.add(cage);
        }

        animate();
    }

    function animate() {
        if (document.getElementById('modal3d').style.display === 'none') return;
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    // Initialize
    window.onload = function() {
        // Attach listeners to all inputs for live update
        document.querySelectorAll('.input-panel input, .input-panel select').forEach(el => {
            el.addEventListener('input', calculate);
        });
        calculate();
    };
</script>

</body>
</html>